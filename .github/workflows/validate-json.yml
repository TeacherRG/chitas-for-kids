name: Validate JSON Files

on:
  push:
    branches: [ main ]
    paths:
      - 'data/*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema
    
    - name: Validate JSON syntax
      run: |
        for file in data/*.json; do
          echo "Validating $file..."
          python -m json.tool "$file" > /dev/null
          if [ $? -eq 0 ]; then
            echo "✅ $file is valid JSON"
          else
            echo "❌ $file has JSON syntax errors"
            exit 1
          fi
        done
    
    - name: Validate index.json structure
      run: |
        python - <<'EOF'
        import json
        import sys
        
        with open('data/index.json', 'r', encoding='utf-8') as f:
            index = json.load(f)
        
        # Check required fields
        required_fields = ['version', 'lastUpdated', 'days']
        for field in required_fields:
            if field not in index:
                print(f"❌ Missing required field: {field}")
                sys.exit(1)
        
        # Check days structure
        for day in index['days']:
            required_day_fields = ['date', 'hebrewDate', 'file', 'available']
            for field in required_day_fields:
                if field not in day:
                    print(f"❌ Day entry missing field: {field}")
                    sys.exit(1)
        
        print("✅ index.json structure is valid")
        EOF
    
    - name: Validate data files match index
      run: |
        python - <<'EOF'
        import json
        import os
        import sys
        
        with open('data/index.json', 'r', encoding='utf-8') as f:
            index = json.load(f)
        
        errors = []
        
        for day in index['days']:
            if day['available']:
                file_path = f"data/{day['file']}"
                if not os.path.exists(file_path):
                    errors.append(f"❌ File not found: {file_path} (marked as available in index)")
        
        if errors:
            for error in errors:
                print(error)
            sys.exit(1)
        else:
            print("✅ All available files exist")
        EOF
    
    - name: Summary
      if: success()
      run: |
        echo "✅ All JSON files are valid!"
        echo "✅ Index structure is correct!"
        echo "✅ All referenced files exist!"
